<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PennyQuest: A Sci-Fi Trivia Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      font-family: 'Orbitron', monospace;
      background: radial-gradient(ellipse at bottom, #0b0c1c 0%, #000010 100%);
      color: #00ffcc;
      text-align: center;
      padding: 2rem;
      overflow-x: hidden;
      position: relative;
      min-height: 100vh;
      z-index: 0;
    }

    body::before, body::after {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none;
      z-index: -1;
    }

    body::before {
      background:
        radial-gradient(2px 2px at 10% 20%, #fff, transparent),
        radial-gradient(1.5px 1.5px at 30% 40%, #fff, transparent),
        radial-gradient(2px 2px at 70% 80%, #fff, transparent),
        radial-gradient(1px 1px at 50% 90%, #fff, transparent),
        radial-gradient(1.5px 1.5px at 80% 15%, #fff, transparent);
      background-repeat: repeat;
      background-size: 200px 200px;
      animation: starsSlow 120s linear infinite;
      opacity: 0.7;
      box-shadow:
        inset 0 0 150px 60px #002233,
        inset 0 0 200px 100px #004466;
      mix-blend-mode: screen;
    }

    body::after {
      background:
        radial-gradient(3px 3px at 15% 25%, #aaffff, transparent),
        radial-gradient(2.5px 2.5px at 35% 45%, #aaffff, transparent),
        radial-gradient(3px 3px at 75% 85%, #aaffff, transparent),
        radial-gradient(2px 2px at 55% 95%, #aaffff, transparent),
        radial-gradient(2.5px 2.5px at 85% 20%, #aaffff, transparent);
      background-repeat: repeat;
      background-size: 150px 150px;
      animation: starsFast 60s linear infinite alternate;
      opacity: 0.8;
    }

    @keyframes starsSlow {
      from {background-position: 0 0;}
      to {background-position: 1000px 1000px;}
    }

    @keyframes starsFast {
      from {background-position: 0 0;}
      to {background-position: -1000px -1000px;}
    }

    h1, h2, h3 {
      text-shadow: 0 0 8px #0ff;
      margin-bottom: 0.3em;
    }
    .hidden {
      display: none;
    }
    button {
      font-family: 'Orbitron', monospace;
      font-size: 1rem;
      border-radius: 4px;
      border: 2px solid #0ff;
      background: transparent;
      color: #0ff;
      padding: 0.8em 1.2em;
      margin: 0.3em;
      cursor: pointer;
      transition: background 0.3s, color 0.3s;
      box-shadow: 0 0 12px #00ffffaa;
    }
    button:hover:not(:disabled) {
      background: #0ff;
      color: black;
      box-shadow: 0 0 20px #00ffff;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      border-color: #666;
      color: #666;
      box-shadow: none;
    }
    .option-button.correct {
      background: #00ff00;
      color: black;
      border-color: #00ff00;
    }
    .option-button.incorrect {
      background: #ff0000;
      color: white;
      border-color: #ff0000;
    }
    .option-button.disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    .options {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 1em;
      margin-top: 1em;
    }
    .option-button {
      min-width: 120px;
    }
    .flag-emoji {
      font-size: 120px;
      margin: 1rem auto;
      display: block;
      border: 2px solid #0ff;
      border-radius: 8px;
      padding: 20px;
      background: rgba(0,255,204,0.1);
      box-shadow: 0 0 15px #0ff;
      width: 200px;
      height: 160px;
      line-height: 120px;
    }
    .store-item {
      margin: 1em 0;
      border: 1px solid #0ff;
      padding: 0.7em;
      border-radius: 6px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 0 8px #00ffccaa;
      background: rgba(0,255,204,0.05);
      text-align: left;
    }
    .store-item button {
      margin-left: 1em;
    }
    .progress {
      margin: 1em 0;
      color: #0ff;
      font-size: 1.1em;
    }
    .button-controls {
      text-align: center;
      margin-top: 2em;
    }
    .button-controls button {
      display: block;
      margin: 0.5em auto;
    }
    .auto-advance-notice {
      color: #ffff00;
      font-size: 1.1em;
      margin: 1em 0;
      text-shadow: 0 0 8px #ffff00;
    }
    .streak-display {
      color: #ffaa00;
      font-size: 1.2em;
      margin: 0.5em 0;
      text-shadow: 0 0 8px #ffaa00;
    }
    .bonus-display {
      color: #00ff00;
      font-size: 1.1em;
      margin: 0.5em 0;
      text-shadow: 0 0 8px #00ff00;
    }
    .bruno-animation {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      text-align: center;
      color: #fff;
      font-size: 2em;
      text-shadow: 0 0 20px #fff;
      animation: brunoAppear 3s ease-in-out;
    }
    @keyframes brunoAppear {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
      30% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
      70% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
    }
    .nebula-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(circle at center, 
        rgba(138, 43, 226, 0.3) 0%, 
        rgba(75, 0, 130, 0.2) 30%, 
        rgba(25, 25, 112, 0.1) 60%, 
        transparent 100%);
      z-index: 999;
      animation: nebulaPulse 3s ease-in-out;
    }
    @keyframes nebulaPulse {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }
    .data-analysis {
      max-width: 600px;
      margin: 0 auto;
      text-align: left;
    }
    .stat-item {
      display: flex;
      justify-content: space-between;
      margin: 0.5em 0;
      padding: 0.5em;
      border: 1px solid #0ff;
      border-radius: 4px;
      background: rgba(0,255,204,0.05);
    }
    .completion-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #000;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffff00;
      font-size: 2em;
      text-align: center;
      animation: flashAndFade 2s ease-in-out;
    }
    @keyframes flashAndFade {
      0% { background: #fff; }
      10% { background: #000; }
      100% { background: #000; }
    }
    .outro-text {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #ffff00;
      font-size: 1.5em;
      text-align: center;
      z-index: 2001;
      max-width: 80%;
      line-height: 1.5;
      text-shadow: 0 0 20px #ffff00;
      animation: starWarsScroll 8s ease-in-out;
    }
    @keyframes starWarsScroll {
      0% { opacity: 0; transform: translate(-50%, 100%); }
      20% { opacity: 1; transform: translate(-50%, -50%); }
      80% { opacity: 1; transform: translate(-50%, -50%); }
      100% { opacity: 0; transform: translate(-50%, -200%); }
    }
    .skip-button {
      background: #ff6600;
      border-color: #ff6600;
      color: white;
    }
    .skip-button:hover {
      background: #ff8833;
      border-color: #ff8833;
    }
  </style>
</head>
<body>
  <div id="main-menu">
    <h1>PennyQuest</h1>
    <h3>A 1970s Sci-Fi Trivia Game</h3>
    <p>Pennies: <span id="pennies">0</span></p>
    <div class="streak-display" id="streak-display"></div>
    <div class="bonus-display" id="bonus-display"></div>
    <h2>Select a Challenge</h2>
    <button onclick="startGame('geography')">Geography</button>
    <button onclick="startGame('flags')">Flags</button>
    <button onclick="startGame('history')">History</button>
    <button onclick="startGame('survival')">üöÄ Survival Mode</button>
    <br/>
    <button onclick="showStore()">Go to Store</button>
    <button id="data-analysis-btn" onclick="showDataAnalysis()" class="hidden">üìä Data Analysis</button>
    
    <div style="margin-top: 3rem; font-size: 1.2em; color: #ff69b4; text-shadow: 0 0 8px #ff69b4;">
      Happy Anniversary Penny!
    </div>
    <div style="margin-top: 1rem; font-size: 1em; color: #ffff00; font-style: italic; text-shadow: 0 0 8px #ffff00;">
      More game categories to be unlocked soon
    </div>
  </div>

  <div id="question-screen" class="hidden">
    <div class="progress" id="progress"></div>
    <h2 id="question"></h2>
    <div id="flag-container"></div>
    <div class="options" id="options"></div>
    <p id="feedback"></p>
    <div id="auto-advance-notice" class="auto-advance-notice hidden"></div>
    <div class="button-controls">
      <button id="skip-btn" class="skip-button hidden" onclick="skipQuestion()">üîß Hack Skip</button>
      <button id="next-btn" onclick="nextQuestion()" disabled>Next</button>
      <button onclick="backToMenu()">Back to Main Menu</button>
    </div>
  </div>

  <div id="store-screen" class="hidden">
    <h2>Store</h2>
    <p>Pennies: <span id="store-pennies"></span></p>
    <div id="store"></div>
    <button onclick="closeStore()">Back to Menu</button>
  </div>

  <div id="data-analysis-screen" class="hidden">
    <h2>üìä Data Analysis</h2>
    <div class="data-analysis" id="data-analysis-content"></div>
    <button onclick="closeDataAnalysis()">Back to Menu</button>
  </div>

  <script>
    // Country mapping for flags with emoji representations
    const countryMap = {
      us: { name: "United States", flag: "üá∫üá∏" },
      gb: { name: "United Kingdom", flag: "üá¨üáß" },
      fr: { name: "France", flag: "üá´üá∑" },
      de: { name: "Germany", flag: "üá©üá™" },
      it: { name: "Italy", flag: "üáÆüáπ" },
      es: { name: "Spain", flag: "üá™üá∏" },
      jp: { name: "Japan", flag: "üáØüáµ" },
      cn: { name: "China", flag: "üá®üá≥" },
      in: { name: "India", flag: "üáÆüá≥" },
      br: { name: "Brazil", flag: "üáßüá∑" },
      ca: { name: "Canada", flag: "üá®üá¶" },
      au: { name: "Australia", flag: "üá¶üá∫" },
      mx: { name: "Mexico", flag: "üá≤üáΩ" },
      ru: { name: "Russia", flag: "üá∑üá∫" },
      kr: { name: "South Korea", flag: "üá∞üá∑" },
      nl: { name: "Netherlands", flag: "üá≥üá±" },
      se: { name: "Sweden", flag: "üá∏üá™" },
      no: { name: "Norway", flag: "üá≥üá¥" },
      dk: { name: "Denmark", flag: "üá©üá∞" },
      ch: { name: "Switzerland", flag: "üá®üá≠" },
      at: { name: "Austria", flag: "üá¶üáπ" },
      be: { name: "Belgium", flag: "üáßüá™" },
      pt: { name: "Portugal", flag: "üáµüáπ" },
      pl: { name: "Poland", flag: "üáµüá±" },
      tr: { name: "Turkey", flag: "üáπüá∑" },
      ar: { name: "Argentina", flag: "üá¶üá∑" },
      eg: { name: "Egypt", flag: "üá™üá¨" },
      za: { name: "South Africa", flag: "üáøüá¶" },
      ng: { name: "Nigeria", flag: "üá≥üá¨" },
      ke: { name: "Kenya", flag: "üá∞üá™" },
      th: { name: "Thailand", flag: "üáπüá≠" },
      sg: { name: "Singapore", flag: "üá∏üá¨" },
      nz: { name: "New Zealand", flag: "üá≥üáø" },
      ie: { name: "Ireland", flag: "üáÆüá™" },
      fi: { name: "Finland", flag: "üá´üáÆ" },
      gr: { name: "Greece", flag: "üá¨üá∑" }
    };

    // Helper to shuffle an array
    function shuffle(arr) {
      return arr.sort(() => Math.random() - 0.5);
    }

    // Generate flag questions dynamically
    function generateFlagQuestions(count = 10) {
      const countryCodes = Object.keys(countryMap);
      const selectedCodes = shuffle([...countryCodes]).slice(0, count);
      
      return selectedCodes.map(code => {
        const correctAnswer = countryMap[code].name;
        const incorrect = shuffle(countryCodes.filter(c => c !== code))
          .slice(0, 3)
          .map(c => countryMap[c].name);
        const options = shuffle([correctAnswer, ...incorrect]);

        return {
          flag: countryMap[code].flag,
          q: "Which country does this flag belong to?",
          options,
          answer: correctAnswer,
          category: 'flags'
        };
      });
    }

    // Questions object
    const questions = {
      geography: [
        {
          q: "Which country has the tallest waterfall in the world?",
          options: ["Norway", "Venezuela", "USA", "India"],
          answer: "Venezuela",
          category: 'geography'
        },
        {
          q: "Which country lists Wolof as a national language?",
          options: ["Ghana", "Senegal", "Nigeria", "Cameroon"],
          answer: "Senegal",
          category: 'geography'
        },
        {
          q: "What is the capital of Australia?",
          options: ["Sydney", "Melbourne", "Canberra", "Perth"],
          answer: "Canberra",
          category: 'geography'
        },
        {
          q: "Which desert is the largest in the world?",
          options: ["Sahara", "Gobi", "Arabian", "Antarctica"],
          answer: "Antarctica",
          category: 'geography'
        },
        {
          q: "Which river is the longest in the world?",
          options: ["Amazon", "Nile", "Yangtze", "Mississippi"],
          answer: "Nile",
          category: 'geography'
        },
        {
          q: "Which country has the most time zones?",
          options: ["Russia", "USA", "China", "France"],
          answer: "France",
          category: 'geography'
        },
        {
          q: "What is the smallest country in the world?",
          options: ["Monaco", "Vatican City", "San Marino", "Liechtenstein"],
          answer: "Vatican City",
          category: 'geography'
        },
        {
          q: "Which mountain range contains Mount Everest?",
          options: ["Andes", "Alps", "Himalayas", "Rockies"],
          answer: "Himalayas",
          category: 'geography'
        },
        {
          q: "Which country is known as the Land of the Rising Sun?",
          options: ["China", "Japan", "Thailand", "South Korea"],
          answer: "Japan",
          category: 'geography'
        },
        {
          q: "What is the deepest ocean trench?",
          options: ["Puerto Rico Trench", "Mariana Trench", "Java Trench", "Peru-Chile Trench"],
          answer: "Mariana Trench",
          category: 'geography'
        },
        {
          q: "Which continent is the driest?",
          options: ["Africa", "Australia", "Antarctica", "Asia"],
          answer: "Antarctica",
          category: 'geography'
        },
        {
          q: "What is the most populous city in the world?",
          options: ["Tokyo", "Delhi", "Shanghai", "S√£o Paulo"],
          answer: "Tokyo",
          category: 'geography'
        }
      ],
      flags: [], // Will be populated dynamically
      history: [
        {
          q: "Which of these is an Ancient Wonder of the World?",
          options: ["Eiffel Tower", "Statue of Zeus", "Great Wall", "Colosseum"],
          answer: "Statue of Zeus",
          category: 'history'
        },
        {
          q: "Which year did the Titanic sink?",
          options: ["1912", "1920", "1905", "1898"],
          answer: "1912",
          category: 'history'
        },
        {
          q: "Who was the first person to walk on the moon?",
          options: ["Buzz Aldrin", "Neil Armstrong", "John Glenn", "Alan Shepard"],
          answer: "Neil Armstrong",
          category: 'history'
        },
        {
          q: "Which empire was ruled by Julius Caesar?",
          options: ["Greek", "Roman", "Byzantine", "Persian"],
          answer: "Roman",
          category: 'history'
        },
        {
          q: "In which year did World War II end?",
          options: ["1944", "1945", "1946", "1947"],
          answer: "1945",
          category: 'history'
        },
        {
          q: "Which ancient civilization built Machu Picchu?",
          options: ["Aztec", "Maya", "Inca", "Olmec"],
          answer: "Inca",
          category: 'history'
        },
        {
          q: "Who painted the Mona Lisa?",
          options: ["Michelangelo", "Leonardo da Vinci", "Rafael", "Donatello"],
          answer: "Leonardo da Vinci",
          category: 'history'
        },
        {
          q: "Which country was NOT part of the original Axis powers in WWII?",
          options: ["Germany", "Italy", "Japan", "Spain"],
          answer: "Spain",
          category: 'history'
        },
        {
          q: "The Berlin Wall fell in which year?",
          options: ["1987", "1989", "1991", "1993"],
          answer: "1989",
          category: 'history'
        },
        {
          q: "Which pharaoh built the Great Pyramid of Giza?",
          options: ["Tutankhamun", "Ramesses II", "Khufu", "Cleopatra"],
          answer: "Khufu",
          category: 'history'
        },
        {
          q: "The Renaissance began in which country?",
          options: ["France", "Italy", "Spain", "Germany"],
          answer: "Italy",
          category: 'history'
        },
        {
          q: "Which war was fought between the North and South in America?",
          options: ["Revolutionary War", "Civil War", "War of 1812", "Spanish-American War"],
          answer: "Civil War",
          category: 'history'
        }
      ]
    };

    // Store items
    const storeItems = [
      { name: "An Ice Cold Shmacking Orangina", cost: 100 },
      { name: "Bruno the Bernese Mountain Dog", cost: 500 },
      { name: "An Indestructible, Apocalypse-proof, Quantum Supercomputer That Always Works", cost: 1000 },
      { name: "A Perfectly Purple Porsche 911 Turbo", cost: 5000 },
      { name: "Seaside Irish Cottage", cost: 10000 },
      { name: "The Answer to the Ultimate Question of Life, the Universe, and Everything", cost: 42000 }
    ];

    // Game state variables
    let currentCategory = null;
    let currentQuestions = [];
    let currentIndex = 0;
    let pennies = 0;
    let storePurchases = [];
    let questionAnswered = false;
    let autoAdvanceTimer = null;
    let countdownTimer = null;
    let gameStats = {};
    let currentStreak = 0;
    let isSurvivalMode = false;
    let usedSkipToday = {};
    let usedBrunoInRound = false;
    let usedPorscheInRound = false;
    let oranginaUsedToday = false;
    let gameCompletedToday = false;

    // Safe localStorage functions with fallbacks
    function safeGetItem(key, defaultValue) {
      try {
        const item = localStorage.getItem(key);
        return item ? JSON.parse(item) : defaultValue;
      } catch (e) {
        console.warn('localStorage not available, using default value');
        return defaultValue;
      }
    }

    function safeSetItem(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch (e) {
        console.warn('localStorage not available, data will not persist');
      }
    }

    // Initialize game
    function initializeGame() {
      pennies = safeGetItem("pennies", 0);
      storePurchases = safeGetItem("purchases", []);
      gameStats = safeGetItem("gameStats", {});
      usedSkipToday = safeGetItem("usedSkipToday", {});
      
      updateStreak();
      updateDisplay();
      checkDailyReset();
      
      if (storePurchases.includes("An Indestructible, Apocalypse-proof, Quantum Supercomputer That Always Works")) {
        document.getElementById("data-analysis-btn").classList.remove("hidden");
      }

      if (storePurchases.includes("The Answer to the Ultimate Question of Life, the Universe, and Everything")) {
        setTimeout(() => showGameCompletion(), 1000);
      }
    }

    function checkDailyReset() {
      const today = new Date().toDateString();
      const lastPlayDate = safeGetItem("lastPlayDate", "");
      
      if (lastPlayDate !== today) {
        usedSkipToday = {};
        oranginaUsedToday = false;
        gameCompletedToday = false;
        safeSetItem("usedSkipToday", usedSkipToday);
      }
    }

    function updateStreak() {
      const today = new Date().toDateString();
      const lastPlayDate = safeGetItem("lastPlayDate", "");
      const streakCount = safeGetItem("streakCount", 0);
      const cottageOwned = storePurchases.includes("Seaside Irish Cottage");
      
      if (lastPlayDate) {
        const lastDate = new Date(lastPlayDate);
        const currentDate = new Date(today);
        const diffTime = currentDate - lastDate;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 1) {
          currentStreak = streakCount;
        } else if (diffDays > 1) {
          if (cottageOwned && diffDays === 2) {
            currentStreak = streakCount;
          } else {
            currentStreak = 0;
          }
        } else {
          currentStreak = streakCount;
        }
      } else {
        currentStreak = 0;
      }
    }

    function updateDisplay() {
      document.getElementById("pennies").textContent = pennies;
      
      if (currentStreak > 0) {
        document.getElementById("streak-display").textContent = `üî• ${currentStreak} Day Streak`;
        document.getElementById("streak-display").style.display = "block";
      } else {
        document.getElementById("streak-display").style.display = "none";
      }
      
      const today = new Date().toDateString();
      const lastPlayDate = safeGetItem("lastPlayDate", "");
      if (!gameCompletedToday && lastPlayDate !== today) {
        const bonusAmount = Math.max(1, currentStreak);
        document.getElementById("bonus-display").textContent = `üí∞ Daily Bonus: ${bonusAmount} pennies available`;
        document.getElementById("bonus-display").style.display = "block";
      } else {
        document.getElementById("bonus-display").style.display = "none";
      }
    }

    function awardDailyBonus() {
      const today = new Date().toDateString();
      const lastPlayDate = safeGetItem("lastPlayDate", "");
      
      if (!gameCompletedToday && lastPlayDate !== today) {
        const bonusAmount = Math.max(1, currentStreak);
        let multiplier = 1;
        
        if (storePurchases.includes("An Ice Cold Shmacking Orangina") && !oranginaUsedToday) {
          multiplier = 3;
          oranginaUsedToday = true;
          document.getElementById("feedback").innerHTML += "<br>üçä Orangina Refreshment Boost: Triple pennies!";
        }
        
        pennies += bonusAmount * multiplier;
        currentStreak++;
        gameCompletedToday = true;
        
        safeSetItem("pennies", pennies);
        safeSetItem("streakCount", currentStreak);
        safeSetItem("lastPlayDate", today);
        
        updateDisplay();
      }
    }

    function recordGameStats(category, correct, total) {
      if (!gameStats[category]) {
        gameStats[category] = { correct: 0, total: 0, successRate: 0 };
      }
      
      gameStats[category].correct += correct;
      gameStats[category].total += total;
      gameStats[category].successRate = Math.round((gameStats[category].correct / gameStats[category].total) * 100);
      
      safeSetItem("gameStats", gameStats);
    }

    function startGame(category) {
      currentCategory = category;
      usedBrunoInRound = false;
      usedPorscheInRound = false;
      isSurvivalMode = (category === 'survival');
      
      if (category === 'survival') {
        let allQuestions = [...questions.geography, ...questions.history];
        allQuestions = allQuestions.concat(generateFlagQuestions(20));
        currentQuestions = shuffle(allQuestions);
        currentQuestions = currentQuestions.slice(0, 50);
      } else if (category === 'flags') {
        currentQuestions = generateFlagQuestions(10);
      } else {
        currentQuestions = [...questions[category]];
        currentQuestions.sort(() => Math.random() - 0.5);
        currentQuestions = currentQuestions.slice(0, 10);
      }
      
      currentIndex = 0;
      document.getElementById("main-menu").classList.add("hidden");
      document.getElementById("store-screen").classList.add("hidden");
      document.getElementById("data-analysis-screen").classList.add("hidden");
      document.getElementById("question-screen").classList.remove("hidden");
      showQuestion();
    }

    function showQuestion() {
      const q = currentQuestions[currentIndex];
      document.getElementById("question").textContent = q.q;
      document.getElementById("feedback").textContent = "";
      document.getElementById("auto-advance-notice").classList.add("hidden");
      
      if (isSurvivalMode) {
        document.getElementById("progress").textContent = `Survival Mode - Question ${currentIndex + 1}`;
      } else {
        document.getElementById("progress").textContent = `Question ${currentIndex + 1} of ${currentQuestions.length}`;
      }
      
      const supercomputerOwned = storePurchases.includes("An Indestructible, Apocalypse-proof, Quantum Supercomputer That Always Works");
      const canSkip = supercomputerOwned && (
        (isSurvivalMode && !usedSkipToday.survival) ||
        (!isSurvivalMode && !usedSkipToday.regular)
      );
      
      if (canSkip) {
        document.getElementById("skip-btn").classList.remove("hidden");
      } else {
        document.getElementById("skip-btn").classList.add("hidden");
      }
      
      if (autoAdvanceTimer) {
        clearTimeout(autoAdvanceTimer);
        autoAdvanceTimer = null;
      }
      if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
      }
      
      questionAnswered = false;
      document.getElementById("next-btn").disabled = true;
      
      const optionsDiv = document.getElementById("options");
      optionsDiv.innerHTML = "";
      
      if (q.flag) {
        document.getElementById("flag-container").innerHTML = `<div class="flag-emoji">${q.flag}</div>`;
      } else {
        document.getElementById("flag-container").innerHTML = "";
      }
      
      q.options.forEach(opt => {
        const btn = document.createElement("button");
        btn.className = "option-button";
        btn.textContent = opt;
        btn.onclick = () => selectAnswer(opt);
        optionsDiv.appendChild(btn);
      });
    }

    function skipQuestion() {
      if (isSurvivalMode) {
        usedSkipToday.survival = true;
      } else {
        usedSkipToday.regular = true;
      }
      safeSetItem("usedSkipToday", usedSkipToday);
      
      document.getElementById("feedback").textContent = "üîß Question hacked and skipped!";
      document.getElementById("skip-btn").classList.add("hidden");
      
      questionAnswered = true;
      document.getElementById("next-btn").disabled = false;
      
      const optionButtons = document.querySelectorAll('.option-button');
      optionButtons.forEach(btn => {
        btn.classList.add('disabled');
        btn.onclick = null;
      });
      
      startAutoAdvance();
    }

    function selectAnswer(choice) {
      if (questionAnswered) return;
      
      questionAnswered = true;
      const q = currentQuestions[currentIndex];
      const isCorrect = choice === q.answer;
      
      const optionButtons = document.querySelectorAll('.option-button');
      optionButtons.forEach(btn => {
        btn.classList.add('disabled');
        btn.onclick = null;
        
        if (btn.textContent === choice) {
          if (isCorrect) {
            btn.classList.add('correct');
          } else {
            btn.classList.add('incorrect');
          }
        }
        
        if (!isCorrect && btn.textContent === q.answer) {
          btn.classList.add('correct');
        }
      });
      
      if (isCorrect) {
        let pennyAmount = 1;
        let bonusText = "";
        
        if (storePurchases.includes("Seaside Irish Cottage")) {
          pennyAmount *= 2;
          bonusText += " üè† Cottage bonus: Double pennies!";
        }
        
        if (storePurchases.includes("A Perfectly Purple Porsche 911 Turbo")) {
          pennyAmount = Math.ceil(pennyAmount * 1.5);
          bonusText += " üèéÔ∏è Porsche speed bonus!";
        }
        
        document.getElementById("feedback").innerHTML = `Correct! +${pennyAmount} ${pennyAmount === 1 ? 'penny' : 'pennies'}${bonusText}`;
        pennies += pennyAmount;
        safeSetItem("pennies", pennies);
        document.getElementById("pennies").textContent = pennies;
        
        document.getElementById("next-btn").disabled = false;
        document.getElementById("skip-btn").classList.add("hidden");
        startAutoAdvance();
      } else {
        const brunoOwned = storePurchases.includes("Bruno the Bernese Mountain Dog");
        
        if (brunoOwned && !usedBrunoInRound && Math.random() < 0.5) {
          showBrunoAnimation();
          usedBrunoInRound = true;
        } else {
          const porscheOwned = storePurchases.includes("A Perfectly Purple Porsche 911 Turbo");
          
          if (porscheOwned && !usedPorscheInRound) {
            document.getElementById("feedback").textContent = `Wrong! Answer was ${q.answer}. üèéÔ∏è Porsche saved your streak!`;
            usedPorscheInRound = true;
            document.getElementById("next-btn").disabled = false;
            document.getElementById("skip-btn").classList.add("hidden");
            startAutoAdvance();
          } else {
            document.getElementById("feedback").textContent = `Wrong! Answer was ${q.answer}`;
            
            if (isSurvivalMode) {
              setTimeout(() => {
                endSurvivalMode();
              }, 3000);
              return;
            } else {
              document.getElementById("next-btn").disabled = false;
              document.getElementById("skip-btn").classList.add("hidden");
              startAutoAdvance();
            }
          }
        }
      }
    }

    function showBrunoAnimation() {
      const nebula = document.createElement('div');
      nebula.className = 'nebula-bg';
      document.body.appendChild(nebula);
      
      const bruno = document.createElement('div');
      bruno.className = 'bruno-animation';
      bruno.innerHTML = `
        <div>üêï Bruno appears!</div>
        <div style="margin-top: 20px;">‚ú® Second chance activated! ‚ú®</div>
      `;
      document.body.appendChild(bruno);
      
      setTimeout(() => {
        if (nebula.parentNode) nebula.parentNode.removeChild(nebula);
        if (bruno.parentNode) bruno.parentNode.removeChild(bruno);
        
        questionAnswered = false;
        const optionButtons = document.querySelectorAll('.option-button');
        optionButtons.forEach(btn => {
          btn.classList.remove('disabled', 'correct', 'incorrect');
          btn.onclick = () => selectAnswer(btn.textContent);
        });
        
        document.getElementById("feedback").textContent = "Bruno gave you a second chance! Choose again.";
      }, 3000);
    }

    function endSurvivalMode() {
      const questionsAnswered = currentIndex + 1;
      recordGameStats('survival', currentIndex, questionsAnswered);
      
      alert(`Survival Mode Complete!\nQuestions answered: ${questionsAnswered}\nGreat job, Space Cadet!`);
      backToMenu();
    }

    function startAutoAdvance() {
      let timeLeft = 5;
      const noticeElement = document.getElementById("auto-advance-notice");
      
      noticeElement.classList.remove("hidden");
      noticeElement.textContent = `Moving on to the next question in ${timeLeft} seconds`;
      
      countdownTimer = setInterval(() => {
        timeLeft--;
        if (timeLeft > 0) {
          noticeElement.textContent = `Moving on to the next question in ${timeLeft} seconds`;
        } else {
          clearInterval(countdownTimer);
          countdownTimer = null;
        }
      }, 1000);
      
      autoAdvanceTimer = setTimeout(() => {
        nextQuestion();
      }, 5000);
    }

    function nextQuestion() {
      if (!questionAnswered && !isSurvivalMode) return;
      
      if (autoAdvanceTimer) {
        clearTimeout(autoAdvanceTimer);
        autoAdvanceTimer = null;
      }
      if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
      }
      
      currentIndex++;
      if (currentIndex < currentQuestions.length && (isSurvivalMode || currentIndex < 10)) {
        showQuestion();
      } else {
        if (!isSurvivalMode) {
          const correctAnswers = currentQuestions.slice(0, 10).reduce((acc, q, i) => {
            // This is a simplified calculation - in a real implementation you'd track this properly
            return acc + (i < currentIndex ? 1 : 0);
          }, 0);
          
          recordGameStats(currentCategory, Math.floor(correctAnswers * 0.7), Math.min(10, currentIndex));
          awardDailyBonus();
        }
        
        backToMenu();
      }
    }

    function backToMenu() {
      if (autoAdvanceTimer) {
        clearTimeout(autoAdvanceTimer);
        autoAdvanceTimer = null;
      }
      if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
      }
      
      document.getElementById("question-screen").classList.add("hidden");
      document.getElementById("store-screen").classList.add("hidden");
      document.getElementById("data-analysis-screen").classList.add("hidden");
      document.getElementById("main-menu").classList.remove("hidden");
      updateDisplay();
      renderStore();
    }

    function renderStore() {
      const storeDiv = document.getElementById("store");
      if (!storeDiv) return;
      storeDiv.innerHTML = "";
      storeItems.forEach(item => {
        const owned = storePurchases.includes(item.name);
        const div = document.createElement("div");
        div.className = "store-item";
        
        let description = `<strong>${item.name}</strong> - ${item.cost} pennies`;
        
        switch(item.name) {
          case "An Ice Cold Shmacking Orangina":
            description += owned ? " (Owned)<br><em>Triple pennies for first game each day!</em>" : "<br><em>Triple pennies for first game each day!</em>";
            break;
          case "Bruno the Bernese Mountain Dog":
            description += owned ? " (Owned)<br><em>50% chance for second chance on wrong answers!</em>" : "<br><em>50% chance for second chance on wrong answers!</em>";
            break;
          case "An Indestructible, Apocalypse-proof, Quantum Supercomputer That Always Works":
            description += owned ? " (Owned)<br><em>Skip questions & unlock Data Analysis!</em>" : "<br><em>Skip questions & unlock Data Analysis!</em>";
            break;
          case "A Perfectly Purple Porsche 911 Turbo":
            description += owned ? " (Owned)<br><em>Wrong answers don't break streak + speed bonuses!</em>" : "<br><em>Wrong answers don't break streak + speed bonuses!</em>";
            break;
          case "Seaside Irish Cottage":
            description += owned ? " (Owned)<br><em>Save streak for 24hrs + double pennies!</em>" : "<br><em>Save streak for 24hrs + double pennies!</em>";
            break;
          case "The Answer to the Ultimate Question of Life, the Universe, and Everything":
            description += owned ? " (Owned)<br><em>Game completed!</em>" : "<br><em>Complete the game!</em>";
            break;
        }
        
        div.innerHTML = description;
        
        if (!owned && pennies >= item.cost) {
          const btn = document.createElement("button");
          btn.textContent = "Buy";
          btn.onclick = () => buyItem(item);
          div.appendChild(btn);
        }
        storeDiv.appendChild(div);
      });
    }

    function buyItem(item) {
      if(pennies >= item.cost){
        pennies -= item.cost;
        storePurchases.push(item.name);
        safeSetItem("pennies", pennies);
        safeSetItem("purchases", storePurchases);
        document.getElementById("pennies").textContent = pennies;
        if (document.getElementById("store-pennies")) {
          document.getElementById("store-pennies").textContent = pennies;
        }
        
        if (item.name === "An Indestructible, Apocalypse-proof, Quantum Supercomputer That Always Works") {
          document.getElementById("data-analysis-btn").classList.remove("hidden");
        }
        
        if (item.name === "The Answer to the Ultimate Question of Life, the Universe, and Everything") {
          setTimeout(() => showGameCompletion(), 1000);
        }
        
        renderStore();
      }
    }

    function showGameCompletion() {
      const overlay = document.createElement('div');
      overlay.className = 'completion-overlay';
      document.body.appendChild(overlay);
      
      setTimeout(() => {
        const outro = document.createElement('div');
        outro.className = 'outro-text';
        outro.innerHTML = `
          <div style="font-size: 2em; margin-bottom: 20px;">GAME COMPLETE</div>
          <div>You have discovered the Answer to the Ultimate Question</div>
          <div>of Life, the Universe, and Everything.</div>
          <div style="margin-top: 30px;">The answer, as we all know, is 42.</div>
          <div style="margin-top: 20px;">But more importantly...</div>
          <div style="margin-top: 20px;">You've mastered the art of trivia</div>
          <div>across the cosmos.</div>
          <div style="margin-top: 30px; font-size: 1.2em;">Congratulations, Space Cadet!</div>
        `;
        document.body.appendChild(outro);
        
        setTimeout(() => {
          if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
          if (outro.parentNode) outro.parentNode.removeChild(outro);
        }, 8000);
      }, 2000);
    }

    function showStore() {
      document.getElementById("main-menu").classList.add("hidden");
      document.getElementById("question-screen").classList.add("hidden");
      document.getElementById("data-analysis-screen").classList.add("hidden");
      document.getElementById("store-screen").classList.remove("hidden");
      document.getElementById("store-pennies").textContent = pennies;
      renderStore();
    }

    function closeStore() {
      document.getElementById("store-screen").classList.add("hidden");
      document.getElementById("main-menu").classList.remove("hidden");
    }

    function showDataAnalysis() {
      document.getElementById("main-menu").classList.add("hidden");
      document.getElementById("question-screen").classList.add("hidden");
      document.getElementById("store-screen").classList.add("hidden");
      document.getElementById("data-analysis-screen").classList.remove("hidden");
      
      const content = document.getElementById("data-analysis-content");
      content.innerHTML = "";
      
      let totalQuestions = 0;
      let totalCorrect = 0;
      
      Object.keys(gameStats).forEach(category => {
        totalQuestions += gameStats[category].total;
        totalCorrect += gameStats[category].correct;
      });
      
      const overallRate = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
      
      content.innerHTML += `
        <h3>üìä Overall Statistics</h3>
        <div class="stat-item">
          <span>Total Questions Answered:</span>
          <span>${totalQuestions}</span>
        </div>
        <div class="stat-item">
          <span>Overall Success Rate:</span>
          <span>${overallRate}%</span>
        </div>
        <div class="stat-item">
          <span>Current Streak:</span>
          <span>${currentStreak} days</span>
        </div>
      `;
      
      content.innerHTML += `<h3>üìà Category Breakdown</h3>`;
      
      ['geography', 'flags', 'history', 'survival'].forEach(category => {
        if (gameStats[category]) {
          const stats = gameStats[category];
          content.innerHTML += `
            <div class="stat-item">
              <span>${category.charAt(0).toUpperCase() + category.slice(1)}:</span>
              <span>${stats.correct}/${stats.total} (${stats.successRate}%)</span>
            </div>
          `;
        }
      });
    }

    function closeDataAnalysis() {
      document.getElementById("data-analysis-screen").classList.add("hidden");
      document.getElementById("main-menu").classList.remove("hidden");
    }

    // Initialize game when page loads
    initializeGame();
