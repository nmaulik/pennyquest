<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PennyQuest: A Sci-Fi Trivia Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet" />
  <style>
    /* Milky Way background from https://css-tricks.com/animated-backgrounds-with-css/ */
    body {
  margin: 0;
  font-family: 'Orbitron', monospace;
  background: radial-gradient(ellipse at bottom, #0b0c1c 0%, #000010 100%);
  color: #00ffcc;
  text-align: center;
  padding: 2rem;
  overflow-x: hidden;
  position: relative;
  min-height: 100vh;
  /* Make sure layers stack */
  z-index: 0;
}

/* Star layers with different sizes and speeds */
body::before, body::after {
  content: "";
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
  z-index: -1;
}

/* Distant small stars */
body::before {
  background:
    radial-gradient(2px 2px at 10% 20%, #fff, transparent),
    radial-gradient(1.5px 1.5px at 30% 40%, #fff, transparent),
    radial-gradient(2px 2px at 70% 80%, #fff, transparent),
    radial-gradient(1px 1px at 50% 90%, #fff, transparent),
    radial-gradient(1.5px 1.5px at 80% 15%, #fff, transparent);
  background-repeat: repeat;
  background-size: 200px 200px;
  animation: starsSlow 120s linear infinite;
  opacity: 0.7;
}

/* Closer twinkling stars */
body::after {
  background:
    radial-gradient(3px 3px at 15% 25%, #aaffff, transparent),
    radial-gradient(2.5px 2.5px at 35% 45%, #aaffff, transparent),
    radial-gradient(3px 3px at 75% 85%, #aaffff, transparent),
    radial-gradient(2px 2px at 55% 95%, #aaffff, transparent),
    radial-gradient(2.5px 2.5px at 85% 20%, #aaffff, transparent);
  background-repeat: repeat;
  background-size: 150px 150px;
  animation: starsFast 60s linear infinite alternate;
  opacity: 0.8;
}

/* Nebula glow effect behind everything */
body::before {
  box-shadow:
    inset 0 0 150px 60px #002233,
    inset 0 0 200px 100px #004466;
  mix-blend-mode: screen;
}

/* Animations */
@keyframes starsSlow {
  from {background-position: 0 0;}
  to {background-position: 1000px 1000px;}
}

@keyframes starsFast {
  from {background-position: 0 0;}
  to {background-position: -1000px -1000px;}
}

    h1, h2, h3 {
      text-shadow: 0 0 8px #0ff;
      margin-bottom: 0.3em;
    }
    .hidden {
      display: none;
    }
    button {
      font-family: 'Orbitron', monospace;
      font-size: 1rem;
      border-radius: 4px;
      border: 2px solid #0ff;
      background: transparent;
      color: #0ff;
      padding: 0.8em 1.2em;
      margin: 0.3em;
      cursor: pointer;
      transition: background 0.3s, color 0.3s;
      box-shadow: 0 0 12px #00ffffaa;
    }
    button:hover:not(:disabled) {
      background: #0ff;
      color: black;
      box-shadow: 0 0 20px #00ffff;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      border-color: #666;
      color: #666;
      box-shadow: none;
    }
    .option-button.correct {
      background: #00ff00;
      color: black;
      border-color: #00ff00;
    }
    .option-button.incorrect {
      background: #ff0000;
      color: white;
      border-color: #ff0000;
    }
    .option-button.disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    .options {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 1em;
      margin-top: 1em;
    }
    .option-button {
      min-width: 120px;
    }
    img.flag {
      width: 220px;
      height: auto;
      border: 2px solid #0ff;
      box-shadow: 0 0 15px #0ff;
      margin: 1rem auto;
      display: block;
      border-radius: 8px;
    }
    .store-item {
      margin: 1em 0;
      border: 1px solid #0ff;
      padding: 0.7em;
      border-radius: 6px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 0 8px #00ffccaa;
      background: rgba(0,255,204,0.05);
    }
    .store-item button {
      margin-left: 1em;
    }
    .progress {
      margin: 1em 0;
      color: #0ff;
      font-size: 1.1em;
    }
    .button-controls {
      text-align: center;
      margin-top: 2em;
    }
    .button-controls button {
      display: block;
      margin: 0.5em auto;
    }
    .auto-advance-notice {
      color: #ffff00;
      font-size: 1.1em;
      margin: 1em 0;
      text-shadow: 0 0 8px #ffff00;
    }
    .streak-display {
      color: #ffaa00;
      font-size: 1.2em;
      margin: 0.5em 0;
      text-shadow: 0 0 8px #ffaa00;
    }
    .bonus-display {
      color: #00ff00;
      font-size: 1.1em;
      margin: 0.5em 0;
      text-shadow: 0 0 8px #00ff00;
    }
    .bruno-animation {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      text-align: center;
      color: #fff;
      font-size: 2em;
      text-shadow: 0 0 20px #fff;
      animation: brunoAppear 3s ease-in-out;
    }
    @keyframes brunoAppear {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
      30% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
      70% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
    }
    .nebula-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(circle at center, 
        rgba(138, 43, 226, 0.3) 0%, 
        rgba(75, 0, 130, 0.2) 30%, 
        rgba(25, 25, 112, 0.1) 60%, 
        transparent 100%);
      z-index: 999;
      animation: nebulaPulse 3s ease-in-out;
    }
    @keyframes nebulaPulse {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }
    .data-analysis {
      max-width: 600px;
      margin: 0 auto;
      text-align: left;
    }
    .stat-item {
      display: flex;
      justify-content: space-between;
      margin: 0.5em 0;
      padding: 0.5em;
      border: 1px solid #0ff;
      border-radius: 4px;
      background: rgba(0,255,204,0.05);
    }
    .completion-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #000;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffff00;
      font-size: 2em;
      text-align: center;
      animation: flashAndFade 2s ease-in-out;
    }
    @keyframes flashAndFade {
      0% { background: #fff; }
      10% { background: #000; }
      100% { background: #000; }
    }
    .outro-text {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #ffff00;
      font-size: 1.5em;
      text-align: center;
      z-index: 2001;
      max-width: 80%;
      line-height: 1.5;
      text-shadow: 0 0 20px #ffff00;
      animation: starWarsScroll 8s ease-in-out;
    }
    @keyframes starWarsScroll {
      0% { opacity: 0; transform: translate(-50%, 100%); }
      20% { opacity: 1; transform: translate(-50%, -50%); }
      80% { opacity: 1; transform: translate(-50%, -50%); }
      100% { opacity: 0; transform: translate(-50%, -200%); }
    }
    .skip-button {
      background: #ff6600;
      border-color: #ff6600;
      color: white;
    }
    .skip-button:hover {
      background: #ff8833;
      border-color: #ff8833;
    }
  </style>
</head>
<body>
  <div id="main-menu">
    <h1>PennyQuest</h1>
    <h3>A 1970s Sci-Fi Trivia Game</h3>
    <p>Pennies: <span id="pennies">0</span></p>
    <div class="streak-display" id="streak-display"></div>
    <div class="bonus-display" id="bonus-display"></div>
    <h2>Select a Challenge</h2>
    <button onclick="startGame('geography')">Geography</button>
    <button onclick="startGame('flags')">Flags</button>
    <button onclick="startGame('history')">History</button>
    <button onclick="startGame('survival')">🚀 Survival Mode</button>
    <br/>
    <button onclick="showStore()">Go to Store</button>
    <button id="data-analysis-btn" onclick="showDataAnalysis()" class="hidden">📊 Data Analysis</button>
  </div>

  <div id="question-screen" class="hidden">
    <div class="progress" id="progress"></div>
    <h2 id="question"></h2>
    <div id="flag-container"></div>
    <div class="options" id="options"></div>
    <p id="feedback"></p>
    <div id="auto-advance-notice" class="auto-advance-notice hidden"></div>
    <div class="button-controls">
      <button id="skip-btn" class="skip-button hidden" onclick="skipQuestion()">🔧 Hack Skip</button>
      <button id="next-btn" onclick="nextQuestion()" disabled>Next</button>
      <button onclick="backToMenu()">Back to Main Menu</button>
    </div>
  </div>

  <div id="store-screen" class="hidden">
    <h2>Store</h2>
    <p>Pennies: <span id="store-pennies"></span></p>
    <div id="store"></div>
    <button onclick="closeStore()">Back to Menu</button>
  </div>

  <div id="data-analysis-screen" class="hidden">
    <h2>📊 Data Analysis</h2>
    <div class="data-analysis" id="data-analysis-content"></div>
    <button onclick="closeDataAnalysis()">Back to Menu</button>
  </div>

  <script>
    // Country mapping for flags
    const countryMap = {
      ad: "Andorra", ae: "United Arab Emirates", af: "Afghanistan", ag: "Antigua and Barbuda",
      ai: "Anguilla", al: "Albania", am: "Armenia", ao: "Angola", aq: "Antarctica",
      ar: "Argentina", as: "American Samoa", at: "Austria", au: "Australia", aw: "Aruba",
      ax: "Åland Islands", az: "Azerbaijan", ba: "Bosnia and Herzegovina", bb: "Barbados",
      bd: "Bangladesh", be: "Belgium", bf: "Burkina Faso", bg: "Bulgaria", bh: "Bahrain",
      bi: "Burundi", bj: "Benin", bl: "Saint Barthélemy", bm: "Bermuda", bn: "Brunei",
      bo: "Bolivia", bq: "Caribbean Netherlands", br: "Brazil", bs: "Bahamas", bt: "Bhutan",
      bv: "Bouvet Island", bw: "Botswana", by: "Belarus", bz: "Belize", ca: "Canada",
      cc: "Cocos (Keeling) Islands", cd: "DR Congo", cf: "Central African Republic",
      cg: "Republic of the Congo", ch: "Switzerland", ci: "Ivory Coast", ck: "Cook Islands",
      cl: "Chile", cm: "Cameroon", cn: "China", co: "Colombia", cr: "Costa Rica",
      cu: "Cuba", cv: "Cape Verde", cw: "Curaçao", cx: "Christmas Island", cy: "Cyprus",
      cz: "Czech Republic", de: "Germany", dj: "Djibouti", dk: "Denmark", dm: "Dominica",
      do: "Dominican Republic", dz: "Algeria", ec: "Ecuador", ee: "Estonia", eg: "Egypt",
      eh: "Western Sahara", er: "Eritrea", es: "Spain", et: "Ethiopia", fi: "Finland",
      fj: "Fiji", fk: "Falkland Islands", fm: "Micronesia", fo: "Faroe Islands", fr: "France",
      ga: "Gabon", gb: "United Kingdom", "gb-eng": "England", "gb-nir": "Northern Ireland",
      "gb-sct": "Scotland", "gb-wls": "Wales", gd: "Grenada", ge: "Georgia", gf: "French Guiana",
      gg: "Guernsey", gh: "Ghana", gi: "Gibraltar", gl: "Greenland", gm: "Gambia", gn: "Guinea",
      gp: "Guadeloupe", gq: "Equatorial Guinea", gr: "Greece", gs: "South Georgia", gt: "Guatemala",
      gu: "Guam", gw: "Guinea-Bissau", gy: "Guyana", hk: "Hong Kong", hm: "Heard Island",
      hn: "Honduras", hr: "Croatia", ht: "Haiti", hu: "Hungary", id: "Indonesia",
      ie: "Ireland", il: "Israel", im: "Isle of Man", in: "India", io: "British Indian Ocean Territory",
      iq: "Iraq", ir: "Iran", is: "Iceland", it: "Italy", je: "Jersey", jm: "Jamaica",
      jo: "Jordan", jp: "Japan", ke: "Kenya", kg: "Kyrgyzstan", kh: "Cambodia", ki: "Kiribati",
      km: "Comoros", kn: "Saint Kitts and Nevis", kp: "North Korea", kr: "South Korea",
      kw: "Kuwait", ky: "Cayman Islands", kz: "Kazakhstan", la: "Laos", lb: "Lebanon",
      lc: "Saint Lucia", li: "Liechtenstein", lk: "Sri Lanka", lr: "Liberia", ls: "Lesotho",
      lt: "Lithuania", lu: "Luxembourg", lv: "Latvia", ly: "Libya", ma: "Morocco",
      mc: "Monaco", md: "Moldova", me: "Montenegro", mf: "Saint Martin", mg: "Madagascar",
      mh: "Marshall Islands", mk: "North Macedonia", ml: "Mali", mm: "Myanmar", mn: "Mongolia",
      mo: "Macau", mp: "Northern Mariana Islands", mq: "Martinique", mr: "Mauritania",
      ms: "Montserrat", mt: "Malta", mu: "Mauritius", mv: "Maldives", mw: "Malawi",
      mx: "Mexico", my: "Malaysia", mz: "Mozambique", na: "Namibia", nc: "New Caledonia",
      ne: "Niger", nf: "Norfolk Island", ng: "Nigeria", ni: "Nicaragua", nl: "Netherlands",
      no: "Norway", np: "Nepal", nr: "Nauru", nu: "Niue", nz: "New Zealand", om: "Oman",
      pa: "Panama", pe: "Peru", pf: "French Polynesia", pg: "Papua New Guinea", ph: "Philippines",
      pk: "Pakistan", pl: "Poland", pm: "Saint Pierre and Miquelon", pn: "Pitcairn Islands",
      pr: "Puerto Rico", ps: "Palestine", pt: "Portugal", pw: "Palau", py: "Paraguay",
      qa: "Qatar", re: "Réunion", ro: "Romania", rs: "Serbia", ru: "Russia", rw: "Rwanda",
      sa: "Saudi Arabia", sb: "Solomon Islands", sc: "Seychelles", sd: "Sudan", se: "Sweden",
      sg: "Singapore", sh: "Saint Helena", si: "Slovenia", sj: "Svalbard and Jan Mayen",
      sk: "Slovakia", sl: "Sierra Leone", sm: "San Marino", sn: "Senegal", so: "Somalia",
      sr: "Suriname", ss: "South Sudan", st: "São Tomé and Príncipe", sv: "El Salvador",
      sx: "Sint Maarten", sy: "Syria", sz: "Eswatini", tc: "Turks and Caicos Islands",
      td: "Chad", tf: "French Southern Territories", tg: "Togo", th: "Thailand", tj: "Tajikistan",
      tk: "Tokelau", tl: "Timor-Leste", tm: "Turkmenistan", tn: "Tunisia", to: "Tonga",
      tr: "Turkey", tt: "Trinidad and Tobago", tv: "Tuvalu", tw: "Taiwan", tz: "Tanzania",
      ua: "Ukraine", ug: "Uganda", um: "U.S. Outlying Islands", us: "United States",
      uy: "Uruguay", uz: "Uzbekistan", va: "Vatican City", vc: "Saint Vincent and the Grenadines",
      ve: "Venezuela", vg: "British Virgin Islands", vi: "U.S. Virgin Islands", vn: "Vietnam",
      vu: "Vanuatu", wf: "Wallis and Futuna", ws: "Samoa", xk: "Kosovo", ye: "Yemen",
      yt: "Mayotte", za: "South Africa", zm: "Zambia", zw: "Zimbabwe"
    };

    // Helper to shuffle an array
    function shuffle(arr) {
      return arr.sort(() => Math.random() - 0.5);
    }

    // Generate flag questions dynamically
    function generateFlagQuestions(count = 10) {
      const countryCodes = Object.keys(countryMap);
      const selectedCodes = shuffle([...countryCodes]).slice(0, count);
      
      return selectedCodes.map(code => {
        const correctAnswer = countryMap[code];
        const incorrect = shuffle(countryCodes.filter(c => c !== code))
          .slice(0, 3)
          .map(c => countryMap[c]);
        const options = shuffle([correctAnswer, ...incorrect]);

        return {
          img: `flags/${code}.png`,
          q: "Which country does this flag belong to?",
          options,
          answer: correctAnswer,
          category: 'flags'
        };
      });
    }

    // Questions object
    const questions = {
      geography: [
        {
          q: "Which country has the tallest waterfall in the world?",
          options: ["Norway", "Venezuela", "USA", "India"],
          answer: "Venezuela",
          category: 'geography'
        },
        {
          q: "Which country lists Wolof as a national language?",
          options: ["Ghana", "Senegal", "Nigeria", "Cameroon"],
          answer: "Senegal",
          category: 'geography'
        },
        {
          q: "What is the capital of Australia?",
          options: ["Sydney", "Melbourne", "Canberra", "Perth"],
          answer: "Canberra",
          category: 'geography'
        },
        {
          q: "Which desert is the largest in the world?",
          options: ["Sahara", "Gobi", "Arabian", "Antarctica"],
          answer: "Antarctica",
          category: 'geography'
        },
        {
          q: "Which river is the longest in the world?",
          options: ["Amazon", "Nile", "Yangtze", "Mississippi"],
          answer: "Nile",
          category: 'geography'
        },
        {
          q: "Which country has the most time zones?",
          options: ["Russia", "USA", "China", "France"],
          answer: "France",
          category: 'geography'
        },
        {
          q: "What is the smallest country in the world?",
          options: ["Monaco", "Vatican City", "San Marino", "Liechtenstein"],
          answer: "Vatican City",
          category: 'geography'
        },
        {
          q: "Which mountain range contains Mount Everest?",
          options: ["Andes", "Alps", "Himalayas", "Rockies"],
          answer: "Himalayas",
          category: 'geography'
        },
        {
          q: "Which country is known as the Land of the Rising Sun?",
          options: ["China", "Japan", "Thailand", "South Korea"],
          answer: "Japan",
          category: 'geography'
        },
        {
          q: "What is the deepest ocean trench?",
          options: ["Puerto Rico Trench", "Mariana Trench", "Java Trench", "Peru-Chile Trench"],
          answer: "Mariana Trench",
          category: 'geography'
        }
      ],
      flags: [], // Will be populated dynamically
      history: [
        {
          q: "Which of these is an Ancient Wonder of the World?",
          options: ["Eiffel Tower", "Statue of Zeus", "Great Wall", "Colosseum"],
          answer: "Statue of Zeus",
          category: 'history'
        },
        {
          q: "Which year did the Titanic sink?",
          options: ["1912", "1920", "1905", "1898"],
          answer: "1912",
          category: 'history'
        },
        {
          q: "Who was the first person to walk on the moon?",
          options: ["Buzz Aldrin", "Neil Armstrong", "John Glenn", "Alan Shepard"],
          answer: "Neil Armstrong",
          category: 'history'
        },
        {
          q: "Which empire was ruled by Julius Caesar?",
          options: ["Greek", "Roman", "Byzantine", "Persian"],
          answer: "Roman",
          category: 'history'
        },
        {
          q: "In which year did World War II end?",
          options: ["1944", "1945", "1946", "1947"],
          answer: "1945",
          category: 'history'
        },
        {
          q: "Which ancient civilization built Machu Picchu?",
          options: ["Aztec", "Maya", "Inca", "Olmec"],
          answer: "Inca",
          category: 'history'
        },
        {
          q: "Who painted the Mona Lisa?",
          options: ["Michelangelo", "Leonardo da Vinci", "Rafael", "Donatello"],
          answer: "Leonardo da Vinci",
          category: 'history'
        },
        {
          q: "Which country was NOT part of the original Axis powers in WWII?",
          options: ["Germany", "Italy", "Japan", "Spain"],
          answer: "Spain",
          category: 'history'
        },
        {
          q: "The Berlin Wall fell in which year?",
          options: ["1987", "1989", "1991", "1993"],
          answer: "1989",
          category: 'history'
        },
        {
          q: "Which pharaoh built the Great Pyramid of Giza?",
          options: ["Tutankhamun", "Ramesses II", "Khufu", "Cleopatra"],
          answer: "Khufu",
          category: 'history'
        }
      ]
    };

    // Store items:
    const storeItems = [
      { name: "An Ice Cold Shmacking Orangina", cost: 100 },
      { name: "Bruno the Bernese Mountain Dog", cost: 500 },
      { name: "An Indestructible, Apocalypse-proof, Quantum Supercomputer That Always Works", cost: 1000 },
      { name: "A Perfectly Purple Porsche 911 Turbo", cost: 5000 },
      { name: "Seaside Irish Cottage", cost: 10000 },
      { name: "The Answer to the Ultimate Question of Life, the Universe, and Everything", cost: 42000 }
    ];

    let currentCategory = null;
    let currentQuestions = [];
    let currentIndex = 0;
    let pennies = parseInt(localStorage.getItem("pennies")) || 0;
    const storePurchases = JSON.parse(localStorage.getItem("purchases") || "[]");
    let questionAnswered = false;
    let autoAdvanceTimer = null;
    let countdownTimer = null;
    let gameStats = JSON.parse(localStorage.getItem("gameStats") || "{}");
    let currentStreak = 0;
    let isSurvivalMode = false;
    let usedSkipToday = JSON.parse(localStorage.getItem("usedSkipToday") || "{}");
    let usedBrunoInRound = false;
    let usedPorscheInRound = false;
    let oranginaUsedToday = false;
    let gameCompletedToday = false;

    // Initialize game
    initializeGame();

    function initializeGame() {
      updateStreak();
      updateDisplay();
      checkDailyReset();
      
      // Check if supercomputer is owned to show data analysis button
      if (storePurchases.includes("An Indestructible, Apocalypse-proof, Quantum Supercomputer That Always Works")) {
        document.getElementById("data-analysis-btn").classList.remove("hidden");
      }

      // Check if the ultimate answer has been purchased
      if (storePurchases.includes("The Answer to the Ultimate Question of Life, the Universe, and Everything")) {
        showGameCompletion();
      }
    }

    function checkDailyReset() {
      const today = new Date().toDateString();
      const lastPlayDate = localStorage.getItem("lastPlayDate");
      
      if (lastPlayDate !== today) {
        // Reset daily items
        usedSkipToday = {};
        oranginaUsedToday = false;
        gameCompletedToday = false;
        localStorage.setItem("usedSkipToday", JSON.stringify(usedSkipToday));
      }
    }

    function updateStreak() {
      const today = new Date().toDateString();
      const lastPlayDate = localStorage.getItem("lastPlayDate");
      const streakCount = parseInt(localStorage.getItem("streakCount") || "0");
      const cottageOwned = storePurchases.includes("Seaside Irish Cottage");
      
      if (lastPlayDate) {
        const lastDate = new Date(lastPlayDate);
        const currentDate = new Date(today);
        const diffTime = currentDate - lastDate;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 1) {
          // Consecutive day
          currentStreak = streakCount;
        } else if (diffDays > 1) {
          // Missed days
          if (cottageOwned && diffDays === 2) {
            // Cottage saves streak for 1 missed day
            currentStreak = streakCount;
          } else {
            currentStreak = 0;
          }
        } else {
          // Same day
          currentStreak = streakCount;
        }
      } else {
        currentStreak = 0;
      }
    }

    function updateDisplay() {
      document.getElementById("pennies").textContent = pennies;
      
      if (currentStreak > 0) {
        document.getElementById("streak-display").textContent = `🔥 ${currentStreak} Day Streak`;
        document.getElementById("streak-display").style.display = "block";
      } else {
        document.getElementById("streak-display").style.display = "none";
      }
      
      // Check for daily bonus
      const today = new Date().toDateString();
      const lastPlayDate = localStorage.getItem("lastPlayDate");
      if (!gameCompletedToday && lastPlayDate !== today) {
        const bonusAmount = Math.max(1, currentStreak);
        document.getElementById("bonus-display").textContent = `💰 Daily Bonus: ${bonusAmount} pennies available`;
        document.getElementById("bonus-display").style.display = "block";
      } else {
        document.getElementById("bonus-display").style.display = "none";
      }
    }

    function awardDailyBonus() {
      const today = new Date().toDateString();
      const lastPlayDate = localStorage.getItem("lastPlayDate");
      
      if (!gameCompletedToday && lastPlayDate !== today) {
        const bonusAmount = Math.max(1, currentStreak);
        let multiplier = 1;
        
        // Check for Orangina triple bonus
        if (storePurchases.includes("An Ice Cold Shmacking Orangina") && !oranginaUsedToday) {
          multiplier = 3;
          oranginaUsedToday = true;
          document.getElementById("feedback").innerHTML += "<br>🍊 Orangina Refreshment Boost: Triple pennies!";
        }
        
        pennies += bonusAmount * multiplier;
        currentStreak++;
        gameCompletedToday = true;
        
        localStorage.setItem("pennies", pennies);
        localStorage.setItem("streakCount", currentStreak);
        localStorage.setItem("lastPlayDate", today);
        
        updateDisplay();
      }
    }

    function recordGameStats(category, correct, total) {
      if (!gameStats[category]) {
        gameStats[category] = { correct: 0, total: 0, successRate: 0 };
      }
      
      gameStats[category].correct += correct;
      gameStats[category].total += total;
      gameStats[category].successRate = Math.round((gameStats[category].correct / gameStats[category].total) * 100);
      
      localStorage.setItem("gameStats", JSON.stringify(gameStats));
    }

    function startGame(category) {
      currentCategory = category;
      usedBrunoInRound = false;
      usedPorscheInRound = false;
      isSurvivalMode = (category === 'survival');
      
      if (category === 'survival') {
        // Combine all questions for survival mode
        let allQuestions = [...questions.geography, ...questions.history];
        // Add flag questions
        allQuestions = allQuestions.concat(generateFlagQuestions(20));
        currentQuestions = shuffle(allQuestions);
        currentQuestions = currentQuestions.slice(0, 50); // Limit to 50 questions max
      } else if (category === 'flags') {
        currentQuestions = generateFlagQuestions(10);
      } else {
        currentQuestions = [...questions[category]];
        currentQuestions.sort(() => Math.random() - 0.5);
        currentQuestions = currentQuestions.slice(0, 10);
      }
      
      currentIndex = 0;
      document.getElementById("main-menu").classList.add("hidden");
      document.getElementById("store-screen").classList.add("hidden");
      document.getElementById("data-analysis-screen").classList.add("hidden");
      document.getElementById("question-screen").classList.remove("hidden");
      showQuestion();
    }

    function showQuestion() {
      const q = currentQuestions[currentIndex];
      document.getElementById("question").textContent = q.q;
      document.getElementById("feedback").textContent = "";
      document.getElementById("auto-advance-notice").classList.add("hidden");
      
      // Show progress
      if (isSurvivalMode) {
        document.getElementById("progress").textContent = `Survival Mode - Question ${currentIndex + 1}`;
      } else {
        document.getElementById("progress").textContent = `Question ${currentIndex + 1} of ${currentQuestions.length}`;
      }
      
      // Show skip button if supercomputer is owned and not used today (or in current survival game)
      const supercomputerOwned = storePurchases.includes("An Indestructible, Apocalypse-proof, Quantum Supercomputer That Always Works");
      const canSkip = supercomputerOwned && (
        (isSurvivalMode && !usedSkipToday.survival) ||
        (!isSurvivalMode && !usedSkipToday.regular)
      );
      
      if (canSkip) {
        document.getElementById("skip-btn").classList.remove("hidden");
      } else {
        document.getElementById("skip-btn").classList.add("hidden");
      }
      
      // Clear any existing timers
      if (autoAdvanceTimer) {
        clearTimeout(autoAdvanceTimer);
        autoAdvanceTimer = null;
      }
      if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
      }
      
      // Reset question state
      questionAnswered = false;
      document.getElementById("next-btn").disabled = true;
      
      const optionsDiv = document.getElementById("options");
      optionsDiv.innerHTML = "";
      
      if (q.img) {
        document.getElementById("flag-container").innerHTML = `<img src="${q.img}" class="flag" alt="Flag">`;
      } else {
        document.getElementById("flag-container").innerHTML = "";
      }
      
      q.options.forEach(opt => {
        const btn = document.createElement("button");
        btn.className = "option-button";
        btn.textContent = opt;
        btn.onclick = () => selectAnswer(opt);
        optionsDiv.appendChild(btn);
      });
    }

    function skipQuestion() {
      if (isSurvivalMode) {
        usedSkipToday.survival = true;
      } else {
        usedSkipToday.regular = true;
      }
      localStorage.setItem("usedSkipToday", JSON.stringify(usedSkipToday));
      
      document.getElementById("feedback").textContent = "🔧 Question hacked and skipped!";
      document.getElementById("skip-btn").classList.add("hidden");
      
      // Mark as answered and enable next
      questionAnswered = true;
      document.getElementById("next-btn").disabled = false;
      
      // Disable option buttons
      const optionButtons = document.querySelectorAll('.option-button');
      optionButtons.forEach(btn => {
        btn.classList.add('disabled');
        btn.onclick = null;
      });
      
      startAutoAdvance();
    }

    function selectAnswer(choice) {
      if (questionAnswered) return;
      
      questionAnswered = true;
      const q = currentQuestions[currentIndex];
      const isCorrect = choice === q.answer;
      
      // Disable all option buttons and highlight the selected answer
      const optionButtons = document.querySelectorAll('.option-button');
      optionButtons.forEach(btn => {
        btn.classList.add('disabled');
        btn.onclick = null;
        
        if (btn.textContent === choice) {
          if (isCorrect) {
            btn.classList.add('correct');
          } else {
            btn.classList.add('incorrect');
          }
        }
        
        if (!isCorrect && btn.textContent === q.answer) {
          btn.classList.add('correct');
        }
      });
      
      if (isCorrect) {
        let pennyAmount = 1;
        let bonusText = "";
        
        // Apply cottage bonus
        if (storePurchases.includes("Seaside Irish Cottage")) {
          pennyAmount *= 2;
          bonusText += " 🏠 Cottage bonus: Double pennies!";
        }
        
        // Apply Porsche speed bonus (if quiz completed faster)
        if (storePurchases.includes("A Perfectly Purple Porsche 911 Turbo")) {
          pennyAmount = Math.ceil(pennyAmount * 1.5);
          bonusText += " 🏎️ Porsche speed bonus!";
        }
        
        document.getElementById("feedback").innerHTML = `Correct! +${pennyAmount} ${pennyAmount === 1 ? 'penny' : 'pennies'}${bonusText}`;
        pennies += pennyAmount;
        localStorage.setItem("pennies", pennies);
        document.getElementById("pennies").textContent = pennies;
        
        document.getElementById("next-btn").disabled = false;
        document.getElementById("skip-btn").classList.add("hidden");
        startAutoAdvance();
      } else {
        // Wrong answer
        const brunoOwned = storePurchases.includes("Bruno the Bernese Mountain Dog");
        
        if (brunoOwned && !usedBrunoInRound && Math.random() < 0.5) {
          // Bruno gives second chance
          showBrunoAnimation();
          usedBrunoInRound = true;
        } else {
          // Handle wrong answer
          const porscheOwned = storePurchases.includes("A Perfectly Purple Porsche 911 Turbo");
          
          if (porscheOwned && !usedPorscheInRound) {
            // Porsche saves streak
            document.getElementById("feedback").textContent = `Wrong! Answer was ${q.answer}. 🏎️ Porsche saved your streak!`;
            usedPorscheInRound = true;
            document.getElementById("next-btn").disabled = false;
            document.getElementById("skip-btn").classList.add("hidden");
            startAutoAdvance();
          } else {
            // Normal wrong answer
            document.getElementById("feedback").textContent = `Wrong! Answer was ${q.answer}`;
            
            if (isSurvivalMode) {
              // End survival mode
              setTimeout(() => {
                endSurvivalMode();
              }, 3000);
              return;
            } else {
              document.getElementById("next-btn").disabled = false;
              document.getElementById("skip-btn").classList.add("hidden");
              startAutoAdvance();
            }
          }
        }
      }
    }

    function showBrunoAnimation() {
      // Create nebula background
      const nebula = document.createElement('div');
      nebula.className = 'nebula-bg';
      document.body.appendChild(nebula);
      
      // Create Bruno animation
      const bruno = document.createElement('div');
      bruno.className = 'bruno-animation';
      bruno.innerHTML = `
        <div>🐕 Bruno appears!</div>
        <div style="margin-top: 20px;">✨ Second chance activated! ✨</div>
      `;
      document.body.appendChild(bruno);
      
      // Remove after animation
      setTimeout(() => {
        if (nebula.parentNode) nebula.parentNode.removeChild(nebula);
        if (bruno.parentNode) bruno.parentNode.removeChild(bruno);
        
        // Reset question for second chance
        questionAnswered = false;
        const optionButtons = document.querySelectorAll('.option-button');
        optionButtons.forEach(btn => {
          btn.classList.remove('disabled', 'correct', 'incorrect');
          btn.onclick = () => selectAnswer(btn.textContent);
        });
        
        document.getElementById("feedback").textContent = "Bruno gave you a second chance! Choose again.";
      }, 3000);
    }

    function endSurvivalMode() {
      const questionsAnswered = currentIndex + 1;
      recordGameStats('survival', currentIndex, questionsAnswered);
      
      alert(`Survival Mode Complete!\nQuestions answered: ${questionsAnswered}\nPennies earned: Check your total!`);
      backToMenu();
    }

    function startAutoAdvance() {
      let timeLeft = 5;
      const noticeElement = document.getElementById("auto-advance-notice");
      
      noticeElement.classList.remove("hidden");
      noticeElement.textContent = `Moving on to the next question in ${timeLeft} seconds`;
      
      countdownTimer = setInterval(() => {
        timeLeft--;
        if (timeLeft > 0) {
          noticeElement.textContent = `Moving on to the next question in ${timeLeft} seconds`;
        } else {
          clearInterval(countdownTimer);
          countdownTimer = null;
        }
      }, 1000);
      
      autoAdvanceTimer = setTimeout(() => {
        nextQuestion();
      }, 5000);
    }

    function nextQuestion() {
      if (!questionAnswered && !isSurvivalMode) return;
      
      if (autoAdvanceTimer) {
        clearTimeout(autoAdvanceTimer);
        autoAdvanceTimer = null;
      }
      if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
      }
      
      currentIndex++;
      if (currentIndex < currentQuestions.length && (isSurvivalMode || currentIndex < 10)) {
        showQuestion();
      } else {
        // End of regular quiz
        if (!isSurvivalMode) {
          const correctAnswers = currentQuestions.slice(0, 10).reduce((acc, q, i) => {
            return acc + (i < currentIndex ? 1 : 0);
          }, 0);
          
          recordGameStats(currentCategory, correctAnswers, Math.min(10, currentIndex));
          awardDailyBonus();
        }
        
        backToMenu();
      }
    }

    function backToMenu() {
      if (autoAdvanceTimer) {
        clearTimeout(autoAdvanceTimer);
        autoAdvanceTimer = null;
      }
      if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
      }
      
      document.getElementById("question-screen").classList.add("hidden");
      document.getElementById("store-screen").classList.add("hidden");
      document.getElementById("data-analysis-screen").classList.add("hidden");
      document.getElementById("main-menu").classList.remove("hidden");
      updateDisplay();
      renderStore();
    }

    function renderStore() {
      const storeDiv = document.getElementById("store");
      if (!storeDiv) return;
      storeDiv.innerHTML = "";
      storeItems.forEach(item => {
        const owned = storePurchases.includes(item.name);
        const div = document.createElement("div");
        div.className = "store-item";
        
        let description = `${item.name} - ${item.cost} pennies`;
        
        // Add item descriptions
        switch(item.name) {
          case "An Ice Cold Shmacking Orangina":
            description += owned ? " (Owned) - Triple pennies for first game each day!" : " - Triple pennies for first game each day!";
            break;
          case "Bruno the Bernese Mountain Dog":
            description += owned ? " (Owned) - 50% chance for second chance on wrong answers!" : " - 50% chance for second chance on wrong answers!";
            break;
          case "An Indestructible, Apocalypse-proof, Quantum Supercomputer That Always Works":
            description += owned ? " (Owned) - Skip questions & unlock Data Analysis!" : " - Skip questions & unlock Data Analysis!";
            break;
          case "A Perfectly Purple Porsche 911 Turbo":
            description += owned ? " (Owned) - Wrong answers don't break streak + speed bonuses!" : " - Wrong answers don't break streak + speed bonuses!";
            break;
          case "Seaside Irish Cottage":
            description += owned ? " (Owned) - Save streak for 24hrs + double pennies!" : " - Save streak for 24hrs + double pennies!";
            break;
          case "The Answer to the Ultimate Question of Life, the Universe, and Everything":
            description += owned ? " (Owned) - Game completed!" : " - Complete the game!";
            break;
        }
        
        div.textContent = description;
        
        if (!owned && pennies >= item.cost) {
          const btn = document.createElement("button");
          btn.textContent = "Buy";
          btn.onclick = () => buyItem(item);
          div.appendChild(btn);
        }
        storeDiv.appendChild(div);
      });
    }

    function buyItem(item) {
      if(pennies >= item.cost){
        pennies -= item.cost;
        storePurchases.push(item.name);
        localStorage.setItem("pennies", pennies);
        localStorage.setItem("purchases", JSON.stringify(storePurchases));
        document.getElementById("pennies").textContent = pennies;
        if (document.getElementById("store-pennies")) {
          document.getElementById("store-pennies").textContent = pennies;
        }
        
        // Special handling for certain items
        if (item.name === "An Indestructible, Apocalypse-proof, Quantum Supercomputer That Always Works") {
          document.getElementById("data-analysis-btn").classList.remove("hidden");
        }
        
        if (item.name === "The Answer to the Ultimate Question of Life, the Universe, and Everything") {
          setTimeout(() => showGameCompletion(), 1000);
        }
        
        renderStore();
      }
    }

    function showGameCompletion() {
      // Create flash overlay
      const overlay = document.createElement('div');
      overlay.className = 'completion-overlay';
      document.body.appendChild(overlay);
      
      // Create outro text
      setTimeout(() => {
        const outro = document.createElement('div');
        outro.className = 'outro-text';
        outro.innerHTML = `
          <div style="font-size: 2em; margin-bottom: 20px;">GAME COMPLETE</div>
          <div>You have discovered the Answer to the Ultimate Question</div>
          <div>of Life, the Universe, and Everything.</div>
          <div style="margin-top: 30px;">The answer, as we all know, is 42.</div>
          <div style="margin-top: 20px;">But more importantly...</div>
          <div style="margin-top: 20px;">You've mastered the art of trivia</div>
          <div>across the cosmos.</div>
          <div style="margin-top: 30px; font-size: 1.2em;">Congratulations, Space Cadet!</div>
        `;
        document.body.appendChild(outro);
        
        // Remove after animation
        setTimeout(() => {
          if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
          if (outro.parentNode) outro.parentNode.removeChild(outro);
        }, 8000);
      }, 2000);
    }

    function showStore() {
      document.getElementById("main-menu").classList.add("hidden");
      document.getElementById("question-screen").classList.add("hidden");
      document.getElementById("data-analysis-screen").classList.add("hidden");
      document.getElementById("store-screen").classList.remove("hidden");
      document.getElementById("store-pennies").textContent = pennies;
      renderStore();
    }

    function closeStore() {
      document.getElementById("store-screen").classList.add("hidden");
      document.getElementById("main-menu").classList.remove("hidden");
    }

    function showDataAnalysis() {
      document.getElementById("main-menu").classList.add("hidden");
      document.getElementById("question-screen").classList.add("hidden");
      document.getElementById("store-screen").classList.add("hidden");
      document.getElementById("data-analysis-screen").classList.remove("hidden");
      
      const content = document.getElementById("data-analysis-content");
      content.innerHTML = "";
      
      // Overall stats
      let totalQuestions = 0;
      let totalCorrect = 0;
      
      Object.keys(gameStats).forEach(category => {
        totalQuestions += gameStats[category].total;
        totalCorrect += gameStats[category].correct;
      });
      
      const overallRate = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
      
      content.innerHTML += `
        <h3>📊 Overall Statistics</h3>
        <div class="stat-item">
          <span>Total Questions Answered:</span>
          <span>${totalQuestions}</span>
        </div>
        <div class="stat-item">
          <span>Overall Success Rate:</span>
          <span>${overallRate}%</span>
        </div>
        <div class="stat-item">
          <span>Current Streak:</span>
          <span>${currentStreak} days</span>
        </div>
      `;
      
      // Category breakdown
      content.innerHTML += `<h3>📈 Category Breakdown</h3>`;
      
      ['geography', 'flags', 'history', 'survival'].forEach(category => {
        if (gameStats[category]) {
          const stats = gameStats[category];
          content.innerHTML += `
            <div class="stat-item">
              <span>${category.charAt(0).toUpperCase() + category.slice(1)}:</span>
              <span>${stats.correct}/${stats.total} (${stats.successRate}%)</span>
            </div>
          `;
        }
      });
    }

    function closeDataAnalysis() {
      document.getElementById("data-analysis-screen").classList.add("hidden");
      document.getElementById("main-menu").classList.remove("hidden");
    }
  </script>
</body>
</html>
